name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Server
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
      run: |
        ssh $SSH_USER@$SSH_HOST << 'EOF'
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Navigate to project (create if doesn't exist)
          if [ ! -d "/var/www/genoun-main" ]; then
            echo "üìÇ Cloning repository for first time..."
            cd /var/www
            git clone https://github.com/EhabER12/testing.git genoun-main
            cd genoun-main
          else
            echo "üì• Pulling latest changes..."
            cd /var/www/genoun-main
            
            # Stash any local changes before pulling
            echo "üíæ Stashing local changes..."
            git stash --include-untracked
            
            # Fetch latest changes
            git fetch origin main
            
            # Reset to remote state (handles divergent branches)
            echo "üîÑ Resetting to remote state..."
            git reset --hard origin/main
            
            # Try to apply stashed changes (don't fail if conflicts)
            echo "üîÑ Applying stashed changes..."
            git stash pop || echo "‚ö†Ô∏è Stash conflicts detected, using remote version"
          fi
          
          # Install backend dependencies
          echo "üîß Installing backend dependencies..."
          cd api
          npm install --production
          
          # Run enrollment script for old course payments (one-time fix)
          echo "üìö Checking for unenrolled paid students..."
          if [ -f "src/scripts/enrollPaidStudents.js" ]; then
            npm run script:enroll-paid-students || echo "‚ö†Ô∏è Enrollment script not available or already run"
          fi
          
          # Install pnpm globally if not exists
          if ! command -v pnpm &> /dev/null; then
            npm install -g pnpm
          fi
          
          # Install frontend dependencies with pnpm
          echo "üé® Installing frontend dependencies..."
          cd ../web
          pnpm install
          
          # Build frontend
          echo "üèóÔ∏è Building frontend..."
          pnpm run build
          
          # Restart or start services with PM2
          echo "‚ôªÔ∏è Restarting services..."
          cd ..
          
          # Check if PM2 processes exist
          if pm2 list | grep -q "genoun"; then
            pm2 restart all
          else
            # First time - start with ecosystem file
            if [ -f "ecosystem.config.js" ]; then
              pm2 start ecosystem.config.js
            else
              # Start manually
              pm2 start api/src/server.js --name genoun-api
              cd web && pm2 start npm --name genoun-web -- start
            fi
            pm2 save
          fi
          
          echo "‚úÖ Deployment successful!"
          pm2 status
        EOF
